<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - USETRAFO</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            background: #f5f5f5;
            font-size: 14px;
        }

        .admin-header {
            background: #02093f;
            color: white;
            padding: 1rem 0;
            margin-bottom: 2rem;
        }

        .admin-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .admin-card h5 {
            color: #02093f;
            margin-bottom: 1rem;
            font-weight: 600;
            border-bottom: 2px solid #02093f;
            padding-bottom: 0.5rem;
        }

        .table-responsive {
            max-height: 600px;
            overflow-y: auto;
        }

        .table {
            font-size: 13px;
        }

        .table thead {
            position: sticky;
            top: 0;
            background: #f8f9fa;
            z-index: 10;
        }

        .badge-status {
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-pendente {
            background: #fff3cd;
            color: #856404;
        }

        .status-enviado {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-aceito {
            background: #d4edda;
            color: #155724;
        }

        .status-recusado {
            background: #f8d7da;
            color: #721c24;
        }

        .btn-sm {
            padding: 0.2rem 0.5rem;
            font-size: 12px;
        }

        .cnpj-result {
            background: #f8f9fa;
            border-left: 4px solid #02093f;
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 3px;
        }

        .search-box {
            margin-bottom: 1rem;
        }

        .stats-box {
            text-align: center;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 5px;
            margin-bottom: 1rem;
        }

        .stats-box .number {
            font-size: 2rem;
            font-weight: bold;
            color: #02093f;
        }

        .stats-box .label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }
    </style>
</head>

<body>
    <!-- Header Admin -->
    <div class="admin-header">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h4 class="mb-0">
                        <i class="fas fa-shield-alt me-2"></i>
                        Painel Administrativo - USETRAFO
                    </h4>
                </div>
                <div class="col-md-6 text-end">
                    <span id="adminName" class="me-3">Admin</span>
                    <button class="btn btn-light btn-sm" onclick="logoutAdmin()">
                        <i class="fas fa-sign-out-alt me-1"></i>Sair
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Form (inicialmente) -->
    <div id="loginSection" class="container" style="max-width: 400px; margin-top: 100px;">
        <div class="admin-card">
            <h5 class="text-center mb-4">Acesso Administrativo</h5>
            <form id="adminLoginForm">
                <div class="mb-3">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" id="adminEmail" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Senha</label>
                    <input type="password" class="form-control" id="adminPassword" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-lock me-2"></i>Entrar
                </button>
            </form>
            <div id="loginError" class="alert alert-danger mt-3 d-none" role="alert"></div>
        </div>
    </div>

    <!-- Admin Dashboard (após login) -->
    <div id="adminDashboard" class="container-fluid d-none">
        <!-- Estatísticas -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-box">
                    <div class="number" id="statsOrcamentos">0</div>
                    <div class="label">Orçamentos</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-box">
                    <div class="number" id="statsClientes">0</div>
                    <div class="label">Clientes</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-box">
                    <div class="number" id="statsPendentes">0</div>
                    <div class="label">Pendentes</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-box">
                    <div class="number" id="statsEnviados">0</div>
                    <div class="label">Enviados</div>
                </div>
            </div>
        </div>

        <!-- Abas -->
        <ul class="nav nav-tabs mb-3" id="adminTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="orcamentos-tab" data-bs-toggle="tab" data-bs-target="#orcamentos"
                    type="button" role="tab">
                    <i class="fas fa-file-invoice me-2"></i>Orçamentos
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="clientes-tab" data-bs-toggle="tab" data-bs-target="#clientes" type="button"
                    role="tab">
                    <i class="fas fa-users me-2"></i>Clientes
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="cnpj-tab" data-bs-toggle="tab" data-bs-target="#cnpj" type="button"
                    role="tab">
                    <i class="fas fa-building me-2"></i>Consulta CNPJ
                </button>
            </li>
        </ul>

        <div class="tab-content" id="adminTabContent">
            <!-- Tab Orçamentos -->
            <div class="tab-pane fade show active" id="orcamentos" role="tabpanel">
                <div class="admin-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">Orçamentos Solicitados</h5>
                        <div class="search-box">
                            <input type="text" class="form-control form-control-sm" id="searchOrcamentos"
                                placeholder="Buscar orçamentos..." style="width: 300px;">
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Data</th>
                                    <th>Cliente</th>
                                    <th>Email</th>
                                    <th>Telefone</th>
                                    <th>Produto/Descrição</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="orcamentosTable">
                                <tr>
                                    <td colspan="8" class="text-center text-muted">
                                        <i class="fas fa-spinner fa-spin me-2"></i>Carregando...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tab Clientes -->
            <div class="tab-pane fade" id="clientes" role="tabpanel">
                <div class="admin-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">Base de Clientes</h5>
                        <div class="search-box">
                            <input type="text" class="form-control form-control-sm" id="searchClientes"
                                placeholder="Buscar clientes..." style="width: 300px;">
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Email</th>
                                    <th>Telefone</th>
                                    <th>CNPJ</th>
                                    <th>CPF/CNPJ</th>
                                    <th>Cadastro</th>
                                    <th>Orçamentos</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="clientesTable">
                                <tr>
                                    <td colspan="8" class="text-center text-muted">
                                        <i class="fas fa-spinner fa-spin me-2"></i>Carregando...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tab CNPJ -->
            <div class="tab-pane fade" id="cnpj" role="tabpanel">
                <div class="admin-card">
                    <h5>Consulta de CNPJ</h5>
                    <p class="text-muted mb-3">Busque informações detalhadas de empresas através do CNPJ</p>

                    <div class="row mb-3">
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="cnpjInput"
                                placeholder="Digite o CNPJ (00.000.000/0000-00)" maxlength="18">
                            <small class="text-muted">Exemplo: 12.345.678/0001-90 ou 12345678000190</small>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-primary w-100" onclick="consultarCNPJ()">
                                <i class="fas fa-search me-2"></i>Consultar
                            </button>
                        </div>
                    </div>

                    <div id="cnpjResult" class="d-none">
                        <div class="cnpj-result">
                            <h6 class="mb-3">Informações da Empresa</h6>
                            <div id="cnpjData"></div>
                        </div>
                    </div>

                    <div id="cnpjLoading" class="text-center d-none">
                        <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                        <p class="mt-2">Consultando CNPJ...</p>
                    </div>

                    <div id="cnpjError" class="alert alert-danger d-none mt-3" role="alert"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Detalhes Orçamento -->
    <div class="modal fade" id="orcamentoModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalhes do Orçamento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="orcamentoModalBody">
                    <p class="text-muted">Carregando...</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" onclick="atualizarStatus()">Atualizar Status</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Histórico do Cliente -->
    <div class="modal fade" id="historicoClienteModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title"><i class="fas fa-history me-2"></i>Histórico do Cliente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="historicoModalBody">
                    <p class="text-center text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Carregando dados...</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Custom JS -->
    <script src="script.js"></script>

    <!-- Admin JS -->
    <script>
        let adminData = null;
        let orcamentosData = [];
        let clientesData = [];
        const API_URL = 'http://localhost:3000/api'; // Backend URL

        // Verificar se já está logado
        document.addEventListener('DOMContentLoaded', function () {
            const token = localStorage.getItem('adminToken');
            const userStr = localStorage.getItem('adminUser');

            if (token && userStr) {
                try {
                    adminData = JSON.parse(userStr);
                    // Opcional: Validar token com o backend aqui (/api/auth/me)
                    initDashboard();
                } catch (e) {
                    console.error('Erro ao carregar sessão:', e);
                    logoutAdmin();
                }
            }

            // Event listeners
            document.getElementById('adminLoginForm').addEventListener('submit', handleAdminLogin);
            document.getElementById('searchOrcamentos').addEventListener('input', filtrarOrcamentos);
            document.getElementById('searchClientes').addEventListener('input', filtrarClientes);
        });

        // Login Admin
        async function handleAdminLogin(e) {
            e.preventDefault();
            const email = document.getElementById('adminEmail').value.trim();
            const senha = document.getElementById('adminPassword').value;
            const errorDiv = document.getElementById('loginError');
            const btnSubmit = e.target.querySelector('button[type="submit"]');

            errorDiv.classList.add('d-none');
            btnSubmit.disabled = true;
            btnSubmit.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Entrando...';

            try {
                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, senha })
                });

                const data = await response.json();

                if (data.success) {
                    // Verificar se é admin
                    if (!data.data.user.is_admin) {
                        throw new Error('Acesso negado. Usuário não é administrador.');
                    }

                    localStorage.setItem('adminToken', data.data.token);
                    localStorage.setItem('adminUser', JSON.stringify(data.data.user));
                    adminData = data.data.user;

                    btnSubmit.innerHTML = '<i class="fas fa-check me-2"></i>Sucesso!';
                    setTimeout(() => initDashboard(), 500);
                } else {
                    throw new Error(data.message || 'Falha no login');
                }
            } catch (error) {
                console.error(error);
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('d-none');
                btnSubmit.disabled = false;
                btnSubmit.innerHTML = '<i class="fas fa-lock me-2"></i>Entrar';
            }
        }

        // Inicializar Dashboard
        function initDashboard() {
            document.getElementById('loginSection').classList.add('d-none');
            document.getElementById('adminDashboard').classList.remove('d-none');
            document.getElementById('adminName').textContent = adminData.nome;

            carregarOrcamentos();
            // carregarClientes(); // Implementar se houver rota
        }

        // Logout
        function logoutAdmin() {
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminUser');
            location.reload();
        }

        // Carregar Orçamentos da API
        async function carregarOrcamentos() {
            const tbody = document.getElementById('orcamentosTable');
            tbody.innerHTML = '<tr><td colspan="8" class="text-center"><i class="fas fa-spinner fa-spin me-2"></i>Carregando orçamentos...</td></tr>';

            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`${API_URL}/orcamentos`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const result = await response.json();

                if (result.success) {
                    orcamentosData = result.data;
                    atualizarTabelaOrcamentos();
                    atualizarEstatisticas();
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Erro ao carregar orçamentos:', error);
                tbody.innerHTML = `<tr><td colspan="8" class="text-center text-danger">Erro ao carregar: ${error.message}</td></tr>`;
                if (error.status === 401) logoutAdmin();
            }
        }

        // Carregar Clientes (Mock ou Implementar Rota)
        function carregarClientes() {
            // Por enquanto, extrair clientes únicos dos orçamentos
            const clientesMap = new Map();

            orcamentosData.forEach(orc => {
                if (!clientesMap.has(orc.cliente_email)) {
                    clientesMap.set(orc.cliente_email, {
                        nome: orc.cliente_nome,
                        email: orc.cliente_email,
                        telefone: orc.cliente_telefone,
                        empresa: orc.cliente_cnpj || '', // Usando CNPJ como empresa/identificador
                        cpfCnpj: orc.cliente_cnpj,
                        cadastro: orc.created_at,
                        origem: 'Orçamento'
                    });
                }
            });

            clientesData = Array.from(clientesMap.values());
            atualizarTabelaClientes();
        }

        // Atualizar Tabela de Orçamentos
        function atualizarTabelaOrcamentos() {
            const tbody = document.getElementById('orcamentosTable');
            const searchTerm = document.getElementById('searchOrcamentos').value.toLowerCase();

            let orcamentosFiltrados = orcamentosData;
            if (searchTerm) {
                orcamentosFiltrados = orcamentosData.filter(o =>
                    (o.cliente_nome && o.cliente_nome.toLowerCase().includes(searchTerm)) ||
                    (o.cliente_email && o.cliente_email.toLowerCase().includes(searchTerm)) ||
                    (o.numero_orcamento && o.numero_orcamento.toLowerCase().includes(searchTerm))
                );
            }

            if (orcamentosFiltrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Nenhum orçamento encontrado</td></tr>';
                return;
            }

            tbody.innerHTML = orcamentosFiltrados.map(orc => {
                const data = new Date(orc.created_at);
                const dataFormatada = data.toLocaleDateString('pt-BR') + ' ' + data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                const statusClass = `status-${orc.status || 'pendente'}`;
                const statusText = (orc.status || 'pendente').toUpperCase();
                // Descrição breve baseada nos itens
                let descricao = 'Sem itens';
                if (orc.itens && orc.itens.length > 0) {
                    descricao = `${orc.itens.length} item(ns): ` + orc.itens.map(i => i.nome_produto).join(', ');
                }
                const descricaoResumida = descricao.substring(0, 50) + (descricao.length > 50 ? '...' : '');

                return `
                    <tr>
                        <td><strong>${orc.numero_orcamento}</strong></td>
                        <td>${dataFormatada}</td>
                        <td>${orc.cliente_nome}</td>
                        <td>${orc.cliente_email}</td>
                        <td>${orc.cliente_telefone || '-'}</td>
                        <td title="${descricao}">${descricaoResumida}</td>
                        <td><span class="badge badge-status ${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="verOrcamento('${orc.id}')" title="Ver Detalhes">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${orc.status === 'pendente' ? `
                            <button class="btn btn-sm btn-warning" onclick="atualizarStatusOrcamento('${orc.id}', 'enviado')" title="Marcar como Enviado">
                                <i class="fas fa-paper-plane"></i>
                            </button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Atualizar Tabela de Clientes
        function atualizarTabelaClientes() {
            const tbody = document.getElementById('clientesTable');
            const searchTerm = document.getElementById('searchClientes').value.toLowerCase();

            let clientesFiltrados = clientesData;
            if (searchTerm) {
                clientesFiltrados = clientesData.filter(c =>
                    c.nome.toLowerCase().includes(searchTerm) ||
                    c.email.toLowerCase().includes(searchTerm) ||
                    (c.cpfCnpj || '').includes(searchTerm)
                );
            }

            if (clientesFiltrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Nenhum cliente encontrado</td></tr>';
                return;
            }

            tbody.innerHTML = clientesFiltrados.map(cliente => {
                const data = new Date(cliente.cadastro);
                const dataFormatada = data.toLocaleDateString('pt-BR');
                const orcamentosCount = orcamentosData.filter(o => o.cliente_email === cliente.email).length;
                const whatsappLink = cliente.telefone ? `https://wa.me/${formatPhoneForWhatsapp(cliente.telefone)}?text=Olá ${cliente.nome}, somos da USETRAFO e gostaríamos de falar sobre seus orçamentos.` : '#';

                return `
                    <tr>
                        <td>${cliente.nome}</td>
                        <td>${cliente.email}</td>
                        <td>${cliente.telefone || '-'}</td>
                        <td>${cliente.cpfCnpj || '-'}</td>
                        <td>${cliente.empresa || '-'}</td>
                        <td>${orcamentosCount}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="verHistoricoCliente('${cliente.email}')" title="Ver Histórico">
                                    <i class="fas fa-history"></i>
                                </button>
                                ${cliente.telefone ? `
                                <a href="${whatsappLink}" target="_blank" class="btn btn-outline-success" title="Chamar no WhatsApp">
                                    <i class="fab fa-whatsapp"></i>
                                </a>` : ''}
                                ${cliente.cpfCnpj ? `
                                <button class="btn btn-outline-info" onclick="consultarCNPJPorCliente('${cliente.cpfCnpj}')" title="Consultar CNPJ">
                                    <i class="fas fa-search"></i>
                                </button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Filtrar Orçamentos
        function filtrarOrcamentos() {
            atualizarTabelaOrcamentos();
        }

        // Filtrar Clientes
        function filtrarClientes() {
            atualizarTabelaClientes();
        }

        // Ver Orçamento Completo
        function verOrcamento(id) {
            const orcamento = orcamentosData.find(o => o.id === id);
            if (!orcamento) return;

            const modalBody = document.getElementById('orcamentoModalBody');
            const data = new Date(orcamento.created_at);

            // Construir lista de itens
            let itensHtml = '<div class="table-responsive"><table class="table table-sm table-bordered"><thead><tr><th>Produto</th><th>Qtd</th><th>Unit.</th><th>Total</th></tr></thead><tbody>';

            if (orcamento.itens && orcamento.itens.length > 0) {
                orcamento.itens.forEach(item => {
                    itensHtml += `
                        <tr>
                            <td>${item.nome_produto}</td>
                            <td>${item.quantidade}</td>
                            <td>R$ ${parseFloat(item.preco_unitario).toFixed(2)}</td>
                            <td>R$ ${parseFloat(item.subtotal).toFixed(2)}</td>
                        </tr>
                    `;
                });
            } else {
                itensHtml += '<tr><td colspan="4">Nenhum item encontrado.</td></tr>';
            }
            itensHtml += '</tbody></table></div>';

            const enderecoEntrega = orcamento.cliente_endereco ?
                (typeof orcamento.cliente_endereco === 'string' ? JSON.parse(orcamento.cliente_endereco) : orcamento.cliente_endereco) : null;

            let enderecoHtml = 'Não informado';
            if (enderecoEntrega) {
                enderecoHtml = `${enderecoEntrega.rua}, ${enderecoEntrega.numero} ${enderecoEntrega.complemento || ''}<br>
                                ${enderecoEntrega.bairro} - ${enderecoEntrega.cidade}/${enderecoEntrega.estado}<br>
                                CEP: ${enderecoEntrega.cep}`;
            }

            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <h6 class="fw-bold text-primary">Dados do Cliente</h6>
                        <p class="mb-1"><strong>Nome:</strong> ${orcamento.cliente_nome}</p>
                        <p class="mb-1"><strong>Email:</strong> ${orcamento.cliente_email}</p>
                        <p class="mb-1"><strong>Telefone:</strong> ${orcamento.cliente_telefone || '-'}</p>
                        <p class="mb-1"><strong>CNPJ/CPF:</strong> ${orcamento.cliente_cnpj || '-'}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <h6 class="fw-bold text-primary">Dados do Pedido</h6>
                        <p class="mb-1"><strong>Número:</strong> ${orcamento.numero_orcamento}</p>
                        <p class="mb-1"><strong>Data:</strong> ${data.toLocaleString('pt-BR')}</p>
                        <p class="mb-1"><strong>Status:</strong> ${orcamento.status.toUpperCase()}</p>
                        <p class="mb-1"><strong>Total:</strong> R$ ${parseFloat(orcamento.total).toFixed(2)}</p>
                    </div>
                </div>
                <hr>
                <div class="row mb-3">
                    <div class="col-12">
                        <h6 class="fw-bold text-primary">Endereço de Entrega</h6>
                        <p class="text-muted small">${enderecoHtml}</p>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-12">
                        <h6 class="fw-bold text-primary">Itens do Pedido</h6>
                        ${itensHtml}
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <h6 class="fw-bold text-primary">Observações</h6>
                        <p class="text-muted small border p-2 rounded">${orcamento.observacoes || 'Nenhuma observação.'}</p>
                    </div>
                </div>
            `;

            const btnAtualizar = document.querySelector('#orcamentoModal .modal-footer .btn-primary');
            btnAtualizar.onclick = () => atualizarStatus(); // Re-bind genérico ou específico se quiser mudar status no modal
            // Para simplificar, vamos esconder o botão de atualizar genérico e usar os da tabela, ou implementar um select no modal.
            // Aqui, vou deixar o modal apenas para visualização detalhada por enquanto.
            btnAtualizar.style.display = 'none';

            const modal = new bootstrap.Modal(document.getElementById('orcamentoModal'));
            modal.show();
        }

        // Atualizar Status do Orçamento (API)
        async function atualizarStatusOrcamento(id, novoStatus) {
            if (!confirm(`Deseja alterar o status para ${novoStatus.toUpperCase()}?`)) return;

            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`${API_URL}/orcamentos/${id}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ status: novoStatus })
                });

                const result = await response.json();
                if (result.success) {
                    // Atualizar lista localmente para refletir a mudança sem recarregar tudo
                    const orc = orcamentosData.find(o => o.id === id);
                    if (orc) orc.status = novoStatus;
                    atualizarTabelaOrcamentos();
                    atualizarEstatisticas();
                    alert('Status atualizado com sucesso!');
                } else {
                    alert('Erro: ' + result.message);
                }
            } catch (error) {
                console.error(error);
                alert('Erro ao comunicar com o servidor.');
            }
        }

        // Atualizar Estatísticas
        function atualizarEstatisticas() {
            document.getElementById('statsOrcamentos').textContent = orcamentosData.length;
            // Clientes únicos
            const uniqueClients = new Set(orcamentosData.map(o => o.cliente_email)).size;
            document.getElementById('statsClientes').textContent = uniqueClients;

            document.getElementById('statsPendentes').textContent = orcamentosData.filter(o => o.status === 'pendente').length;
            document.getElementById('statsEnviados').textContent = orcamentosData.filter(o => o.status === 'enviado').length;

            // Atualizar lista de clientes baseada nos orçamentos carregados
            carregarClientes();
        }

        // Formatação automática de CNPJ no input
        document.addEventListener('DOMContentLoaded', function () {
            const cnpjInput = document.getElementById('cnpjInput');
            if (cnpjInput) {
                cnpjInput.addEventListener('input', function (e) {
                    let value = e.target.value.replace(/\D/g, '');

                    // Limitar a 14 dígitos
                    if (value.length > 14) {
                        value = value.substring(0, 14);
                    }

                    // Formatar: XX.XXX.XXX/XXXX-XX
                    if (value.length > 12) {
                        value = value.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/, '$1.$2.$3/$4-$5');
                    } else if (value.length > 8) {
                        value = value.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})$/, '$1.$2.$3/$4');
                    } else if (value.length > 5) {
                        value = value.replace(/^(\d{2})(\d{3})(\d{3})$/, '$1.$2.$3');
                    } else if (value.length > 2) {
                        value = value.replace(/^(\d{2})(\d{3})$/, '$1.$2');
                    }

                    e.target.value = value;
                });
            }
        });

        // Consultar CNPJ
        async function consultarCNPJ() {
            // Remover toda formatação e pegar apenas números
            let cnpj = document.getElementById('cnpjInput').value.replace(/\D/g, '');

            // Validar se tem exatamente 14 dígitos
            if (!cnpj || cnpj.length !== 14) {
                alert('CNPJ deve ter exatamente 14 dígitos. Digite: 00.000.000/0000-00');
                document.getElementById('cnpjInput').focus();
                return;
            }

            // Validar CNPJ básico (verificar se não é todos os dígitos iguais)
            if (/^(\d)\1{13}$/.test(cnpj)) {
                alert('CNPJ inválido. Não pode ter todos os dígitos iguais.');
                return;
            }

            document.getElementById('cnpjResult').classList.add('d-none');
            document.getElementById('cnpjError').classList.add('d-none');
            document.getElementById('cnpjLoading').classList.remove('d-none');

            try {
                // Tentar API ReceitaWS primeiro
                let data = null;
                let errorMsg = null;

                try {
                    // API ReceitaWS com timeout de 10 segundos
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000);

                    const response = await fetch(`https://www.receitaws.com.br/v1/${cnpj}`, {
                        signal: controller.signal,
                        headers: {
                            'Accept': 'application/json'
                        }
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    data = await response.json();

                    // Verificar se a resposta é um erro
                    if (data.status === 'ERROR' || data.error) {
                        errorMsg = data.message || data.error || 'CNPJ não encontrado ou inválido';
                        throw new Error(errorMsg);
                    }

                    // Verificar se tem dados válidos
                    if (!data.nome && !data.razao_social) {
                        errorMsg = 'CNPJ não encontrado ou dados indisponíveis';
                        throw new Error(errorMsg);
                    }
                } catch (apiError) {
                    console.error('Erro na API ReceitaWS:', apiError);

                    // Tentar API alternativa (BrasilAPI)
                    try {
                        const brasilApiResponse = await fetch(`https://brasilapi.com.br/api/cnpj/v1/${cnpj}`, {
                            headers: {
                                'Accept': 'application/json'
                            }
                        });

                        if (brasilApiResponse.ok) {
                            const brasilData = await brasilApiResponse.json();

                            // Converter formato BrasilAPI para formato ReceitaWS
                            data = {
                                nome: brasilData.razao_social || brasilData.nome || '-',
                                fantasia: brasilData.nome_fantasia || brasilData.fantasia || '-',
                                cnpj: brasilData.cnpj || cnpj,
                                situacao: brasilData.descricao_situacao_cadastral || brasilData.situacao || '-',
                                abertura: brasilData.data_inicio_atividade || brasilData.abertura || '-',
                                natureza_juridica: brasilData.natureza_juridica || '-',
                                logradouro: brasilData.logradouro || '-',
                                numero: brasilData.numero || '-',
                                complemento: brasilData.complemento || '-',
                                bairro: brasilData.bairro || '-',
                                cep: brasilData.cep ? brasilData.cep.replace(/^(\d{5})(\d{3})$/, '$1-$2') : '-',
                                municipio: brasilData.municipio || '-',
                                uf: brasilData.uf || '-',
                                telefone: brasilData.ddd_telefone_1 || brasilData.telefone || '-',
                                email: brasilData.email || '-',
                                capital_social: brasilData.capital_social ? `R$ ${parseFloat(brasilData.capital_social).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}` : '-',
                                atividades_secundarias: brasilData.qsa || []
                            };
                        } else {
                            throw new Error('BrasilAPI também falhou');
                        }
                    } catch (brasilApiError) {
                        console.error('Erro na API BrasilAPI:', brasilApiError);
                        errorMsg = errorMsg || 'Erro ao consultar CNPJ. A API pode estar temporariamente indisponível ou o CNPJ pode estar incorreto.';
                        throw new Error(errorMsg);
                    }
                }

                document.getElementById('cnpjLoading').classList.add('d-none');

                // Exibir dados
                const cnpjDataDiv = document.getElementById('cnpjData');
                cnpjDataDiv.innerHTML = `
                    <div class="row mb-2">
                        <div class="col-md-6"><strong>Razão Social:</strong></div>
                        <div class="col-md-6">${data.nome || '-'}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-6"><strong>Nome Fantasia:</strong></div>
                        <div class="col-md-6">${data.fantasia || '-'}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-6"><strong>CNPJ:</strong></div>
                        <div class="col-md-6">${data.cnpj || '-'}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-6"><strong>Situação:</strong></div>
                        <div class="col-md-6">${data.situacao || '-'}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-6"><strong>Data de Abertura:</strong></div>
                        <div class="col-md-6">${data.abertura || '-'}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-6"><strong>Natureza Jurídica:</strong></div>
                        <div class="col-md-6">${data.natureza_juridica || '-'}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-6"><strong>Logradouro:</strong></div>
                        <div class="col-md-6">${data.logradouro || '-'}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-6"><strong>Número:</strong></div>
                        <div class="col-md-6">${data.numero || '-'}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-6"><strong>Complemento:</strong></div>
                        <div class="col-md-6">${data.complemento || '-'}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-6"><strong>Bairro:</strong></div>
                        <div class="col-md-6">${data.bairro || '-'}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-6"><strong>CEP:</strong></div>
                        <div class="col-md-6">${data.cep || '-'}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-6"><strong>Cidade/UF:</strong></div>
                        <div class="col-md-6">${data.municipio || '-'} / ${data.uf || '-'}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-6"><strong>Telefone:</strong></div>
                        <div class="col-md-6">${data.telefone || '-'}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-6"><strong>Email:</strong></div>
                        <div class="col-md-6">${data.email || '-'}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-6"><strong>Capital Social:</strong></div>
                        <div class="col-md-6">${data.capital_social || '-'}</div>
                    </div>
                    ${data.atividades_secundarias && data.atividades_secundarias.length > 0 ? `
                        <div class="row mb-2">
                            <div class="col-12">
                                <strong>Atividades Secundárias:</strong>
                                <ul class="mt-2">
                                    ${data.atividades_secundarias.map(ativ => `<li>${ativ.text}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    ` : ''}
                `;

                document.getElementById('cnpjResult').classList.remove('d-none');
            } catch (error) {
                document.getElementById('cnpjLoading').classList.add('d-none');

                let errorMessage = 'Erro ao consultar CNPJ. ';

                if (error.name === 'AbortError') {
                    errorMessage += 'Tempo limite excedido. Tente novamente.';
                } else if (error.message) {
                    errorMessage += error.message;
                } else {
                    errorMessage += 'Verifique se o CNPJ está correto e tente novamente.';
                }

                document.getElementById('cnpjError').textContent = errorMessage;
                document.getElementById('cnpjError').classList.remove('d-none');
                console.error('Erro na consulta CNPJ:', error);
                console.log('CNPJ consultado:', cnpj);
            }
        }

        // ==========================================
        // CRM FUNCTIONS
        // ==========================================

        function formatPhoneForWhatsapp(phone) {
            if (!phone) return null;
            // Manter apenas números
            let cleanPhone = phone.replace(/\D/g, '');
            // Se não tiver 55 (DDI brasil) e tiver 10 ou 11 digitos, adicionar
            if (cleanPhone.length >= 10 && cleanPhone.length <= 11) {
                cleanPhone = '55' + cleanPhone;
            }
            return cleanPhone;
        }

        function verHistoricoCliente(email) {
            const cliente = clientesData.find(c => c.email === email);
            if (!cliente) return;

            const orcamentosDoCliente = orcamentosData.filter(o => o.cliente_email === email);

            // Calcular totais
            const totalGasto = orcamentosDoCliente.reduce((acc, curr) => acc + parseFloat(curr.total), 0);
            const ticketMedio = totalGasto / orcamentosDoCliente.length || 0;

            const modalBody = document.getElementById('historicoModalBody');

            let listaOrcsHtml = `
                <div class="table-responsive mt-3">
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Nº Pedido</th>
                                <th>Status</th>
                                <th>Valor</th>
                                <th>Ação</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            if (orcamentosDoCliente.length > 0) {
                orcamentosDoCliente.sort((a, b) => new Date(b.created_at) - new Date(a.created_at)); // Mais recentes primeiro

                listaOrcsHtml += orcamentosDoCliente.map(orc => {
                    const data = new Date(orc.created_at).toLocaleDateString('pt-BR');
                    return `
                        <tr>
                            <td>${data}</td>
                            <td>${orc.numero_orcamento}</td>
                            <td><span class="badge badge-status status-${orc.status}">${orc.status.toUpperCase()}</span></td>
                            <td>R$ ${parseFloat(orc.total).toFixed(2)}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="verOrcamento('${orc.id}'); bootstrap.Modal.getInstance(document.getElementById('historicoClienteModal')).hide();">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } else {
                listaOrcsHtml += '<tr><td colspan="5" class="text-center">Nenhum pedido encontrado.</td></tr>';
            }

            listaOrcsHtml += '</tbody></table></div>';

            modalBody.innerHTML = `
                <div class="row mb-3">
                    <div class="col-md-12">
                        <div class="d-flex align-items-center mb-3">
                            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px; font-size: 20px;">
                                ${cliente.nome.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <h5 class="mb-0">${cliente.nome}</h5>
                                <small class="text-muted"><i class="fas fa-envelope me-1"></i> ${cliente.email}</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row g-2 mb-3">
                    <div class="col-4">
                        <div class="border rounded p-2 text-center bg-light">
                            <small class="d-block text-muted">Pedidos</small>
                            <strong class="h5 mb-0 text-primary">${orcamentosDoCliente.length}</strong>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="border rounded p-2 text-center bg-light">
                            <small class="d-block text-muted">Total Gasto</small>
                            <strong class="h5 mb-0 text-success">R$ ${totalGasto.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</strong>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="border rounded p-2 text-center bg-light">
                            <small class="d-block text-muted">Ticket Médio</small>
                            <strong class="h5 mb-0 text-info">R$ ${ticketMedio.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</strong>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-2">
                         <p class="mb-1"><strong>Telefone:</strong> ${cliente.telefone || '-'}</p>
                    </div>
                    <div class="col-md-6 mb-2">
                         <p class="mb-1"><strong>CNPJ/CPF:</strong> ${cliente.cpfCnpj || '-'}</p>
                    </div>
                    <div class="col-12">
                         <p class="mb-1"><strong>Empresa:</strong> ${cliente.empresa || '-'}</p>
                    </div>
                </div>

                <h6 class="mt-3 border-bottom pb-2">Histórico de Pedidos</h6>
                ${listaOrcsHtml}
            `;

            const modal = new bootstrap.Modal(document.getElementById('historicoClienteModal'));
            modal.show();
        }

        // Consultar CNPJ por Cliente
        function consultarCNPJPorCliente(cnpj) {
            // Remover formatação e formatar novamente
            const cnpjLimpo = cnpj.replace(/\D/g, '');
            let cnpjFormatado = '';

            if (cnpjLimpo.length === 14) {
                cnpjFormatado = cnpjLimpo.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/, '$1.$2.$3/$4-$5');
            } else {
                cnpjFormatado = cnpjLimpo;
            }

            document.getElementById('cnpjInput').value = cnpjFormatado;
            document.getElementById('cnpj-tab').click();
            setTimeout(() => consultarCNPJ(), 300);
        }
    </script>
</body>

</html>