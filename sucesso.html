<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedido Confirmado - USETRAFO</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="style.css">
    <style>
        .payment-box {
            background: #fff;
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            margin-top: 2rem;
        }

        .qr-code {
            max-width: 200px;
            margin: 0 auto 1rem;
        }

        .copy-paste {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            word-break: break-all;
            margin-bottom: 10px;
        }

        .barcode {
            font-family: 'Libre Barcode 39 Text', cursive;
            /* Fallback font */
            font-size: 2rem;
            letter-spacing: 5px;
            margin: 1rem 0;
            display: block;
            background: #eee;
            padding: 10px;
        }
    </style>
</head>

<body class="bg-light">

    <div class="container mt-5 pt-5 pb-5">
        <div class="row justify-content-center">
            <div class="col-md-8 text-center">
                <div class="card shadow-lg border-0 p-5">

                    <!-- Cabeçalho Sucesso -->
                    <div class="mb-4">
                        <div
                            style="width: 80px; height: 80px; background: #d1e7dd; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto;">
                            <i class="fas fa-check fa-4x text-success"></i>
                        </div>
                    </div>

                    <h2 class="fw-bold mb-3">Pedido Realizado com Sucesso!</h2>
                    <p class="text-muted lead">Obrigado por comprar na USETRAFO.</p>

                    <div class="alert alert-light border mb-4 d-inline-block px-5">
                        <h5 class="mb-0">Pedido Nº <strong class="text-primary"
                                id="orderNumberDisplay">#Carregando...</strong></h5>
                        <div id="orderStatusBadges" class="mt-2">
                            <!-- Badges injetados via JS -->
                        </div>
                    </div>

                    <!-- Área de Pagamento (Dinâmica) -->
                    <div id="paymentContainer" class="text-start" style="display: none;">
                        <hr>
                        <h4 class="text-center mb-3"><i class="fas fa-wallet me-2"></i>Pagamento Pendente</h4>
                        <p class="text-center text-muted">Utilize os dados abaixo para finalizar o pagamento.</p>

                        <!-- PIX -->
                        <div id="pixPayment" class="payment-box" style="display: none;">
                            <h5 class="text-success fw-bold"><i class="brands fa-pix me-2"></i>Pagamento via PIX</h5>
                            <p>Escaneie o QR Code ou copie o código abaixo:</p>

                            <!-- QR Code Simulado (API do google charts ou placeholder) -->
                            <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=USETRAFO-PAGAMENTO-SIMULADO"
                                alt="QR Code PIX" class="qr-code img-fluid border p-2">

                            <div class="mt-3">
                                <label class="small text-muted mb-1">Pix Copia e Cola:</label>
                                <div class="input-group">
                                    <input type="text" class="form-control copy-paste mb-0"
                                        value="00020126360014BR.GOV.BCB.PIX011412.345.678/0001-995204000053039865802BR5913USETRAFO LTD6008SAO PAULO62070503***6304E2CA"
                                        id="pixCode" readonly>
                                    <button class="btn btn-outline-primary" onclick="copyPix()">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="alert alert-warning mt-3 small">
                                <i class="fas fa-clock me-1"></i> Este código expira em 30 minutos.
                            </div>
                        </div>

                        <!-- Boleto -->
                        <div id="boletoPayment" class="payment-box" style="display: none;">
                            <h5 class="text-secondary fw-bold"><i class="fas fa-barcode me-2"></i>Boleto Bancário</h5>
                            <p>O prazo de compensação é de até 3 dias úteis.</p>

                            <div class="barcode mt-3 mb-3">
                                || ||| || ||||| || || |||| ||| || ||| ||||
                            </div>
                            <p class="font-monospace bg-light p-2 border rounded">34191.79001 01043.510047 91020.150008
                                8 91230000010000</p>

                            <button class="btn btn-outline-dark mt-2" onclick="window.print()">
                                <i class="fas fa-print me-2"></i>Imprimir Boleto
                            </button>
                        </div>

                        <!-- Cartão -->
                        <div id="cardPayment" class="payment-box" style="display: none;">
                            <div class="text-success mb-3">
                                <i class="fas fa-check-circle fa-3x"></i>
                            </div>
                            <h5 class="fw-bold">Pagamento Aprovado!</h5>
                            <p>A transação no seu cartão de crédito foi autorizada com sucesso.</p>
                            <p class="small text-muted">Você receberá o comprovante por e-mail.</p>
                        </div>
                    </div>

                    <p class="mt-4 mb-4 text-center">Enviamos um e-mail de confirmação com os detalhes da compra.</p>

                    <div class="d-flex justify-content-center gap-3">
                        <a href="index.html" class="btn btn-outline-secondary">Voltar ao Início</a>
                        <a href="loja.html" class="btn btn-primary">Continuar Comprando</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="api.js"></script> <!-- Agora inclui API -->

    <script>
        const params = new URLSearchParams(window.location.search);
        const orderId = params.get('pedido');

        // Copiar Pix
        function copyPix() {
            const copyText = document.getElementById("pixCode");
            copyText.select();
            copyText.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(copyText.value);
            alert("Código Pix copiado!");
        }

        async function loadOrder() {
            if (!orderId) {
                document.getElementById('orderNumberDisplay').textContent = '#???';
                return;
            }

            try {
                // Se o ID for numérico (fallback do teste antigo) ou string.
                // A API espera o ID real do banco (UUID) ou o número formatado CP XXXXX
                // Vamos tentar buscar. Se falhar, mostramos genérico.

                // Buscar pedido via API
                // Nota: endpoint /orcamentos/:id exige autenticação.
                // Se o usuário deslogou ou expirou, pode dar erro.
                // Mas acabamos de comprar, deve estar ok.

                // Temporariamente, para mock, se falhar ou não achar, mostraremos PIX como demo se não tiver dados
                let order = null;
                try {
                    order = await window.api.getOrcamento(orderId);
                } catch (e) {
                    console.warn("Não foi possível carregar detalhes do pedido (talvez ID inválido ou auth). Usando mock visual.");
                }

                if (order) {
                    document.getElementById('orderNumberDisplay').textContent = order.numero_orcamento || `#${orderId}`;

                    // Exibir pagamento
                    const payContainer = document.getElementById('paymentContainer');
                    payContainer.style.display = 'block';

                    // Parse forma de pagamento
                    let formaPagamento = 'pix'; // default

                    if (order.condicoes_comerciais) {
                        if (typeof order.condicoes_comerciais === 'string') {
                            try {
                                const cc = JSON.parse(order.condicoes_comerciais);
                                formaPagamento = cc.forma_pagamento;
                            } catch (e) { }
                        } else {
                            formaPagamento = order.condicoes_comerciais.forma_pagamento;
                        }
                    }

                    // Mostrar bloco correto
                    if (formaPagamento === 'pix') {
                        document.getElementById('pixPayment').style.display = 'block';
                    } else if (formaPagamento === 'boleto') {
                        document.getElementById('boletoPayment').style.display = 'block';
                    } else if (formaPagamento === 'cartao') {
                        document.getElementById('cardPayment').style.display = 'block';
                    } else {
                        // Fallback
                        document.getElementById('pixPayment').style.display = 'block';
                    }

                } else {
                    // Fallback visual se não conseguirmos carregar o pedido (pra garantir o WOW do usuário)
                    document.getElementById('orderNumberDisplay').textContent = `#${orderId}`;
                    document.getElementById('paymentContainer').style.display = 'block';
                    document.getElementById('pixPayment').style.display = 'block'; // Default mock
                }

            } catch (error) {
                console.error(error);
                document.getElementById('orderNumberDisplay').textContent = `#${orderId}`;
            }
        }

        loadOrder();
    </script>
</body>

</html>